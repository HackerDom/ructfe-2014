#!/usr/bin/env python3

import os
import socket
import sys
import traceback
import re
import random

S = random.randrange(1, 9)

PORT = 1111 * S
LAST_OCTET = str(100 + S)

TIMEOUT = 30
CONNECT_TIMEOUT = 10

NOP_COUNT = 1

MSG_OUT_SIZE = 1


def readline(s):
    chars = []
    while True:
        a = s.recv(1)
        chars.append(a)
        if not a or a == b"\n":
            return b"".join(chars)


def pad_and_send(s, msg):
    l = int(MSG_OUT_SIZE)
    if len(msg) < l:
        msg += " " + "A" * (l - len(msg) - 1)
    msg += "\n"
    s.sendall(msg.encode())


def hack(host):
    try:
        s = socket.create_connection((host, PORT), CONNECT_TIMEOUT)
        s.settimeout(TIMEOUT)
    except Exception:
        print("No connect")
        return

    hello_re = rb"\+ I've got (\d+) flags"
    flags_num = int(re.match(hello_re, readline(s).strip()).group(1))

    for i in range(NOP_COUNT):
        pad_and_send(s, "flags")
        print(readline(s))


def main(host):
    host = host + LAST_OCTET
    print("Hacking %s" % host)
    hack(host)

if __name__ == "__main__":
    try:
        sys.exit(main(sys.argv[1]))
    except Exception:
        traceback.print_exc()
        sys.exit(1)
