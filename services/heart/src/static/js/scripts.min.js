Date.prototype.toReadString=function(){function g(h){return""+(h>9?h:"0"+h)}var b=this.getDate();var e=this.getMonth()+1;var d=this.getFullYear();var a=this.getHours();var c=this.getMinutes();var f=this.getSeconds();return g(d)+"-"+g(e)+"-"+g(b)+" "+g(a)+":"+g(c)+":"+g(f)};var login=$.cookie("login");if(login){$("#login").find("a").text(login);$("#login-link").hide();$("#register-link").hide()}else{$("#func").attr("disabled",true);$("#cond").attr("disabled",true);$("#value").attr("disabled",true);$("#mssg").attr("disabled",true);$(".form-alerts").find("button").attr("disabled",true)}var ex=$.cookie("expr");if(ex){var parts=ex.split(":");$("#func").val(parts[0]);$("#cond").val(parts[1]);$("#value").val(parts[2]);$("#mssg").val(parts[3])}function addRow(b,a,d){var c=$("<tr class='"+a+"'/>");d.forEach(function(e){var f=$("<td/>").text(e);c.append(f)});b.append(c)}function updateAlerts(){var a=$(".table");$.ajax({url:"/alerts/"}).done(function(b){a.find("tr").remove();if(b&&b.msg){addRow(a,"warning",[new Date(b.dt).toReadString(),b.msg])}else{addRow(a,"",["Looks good",""])}}).fail(function(b){a.find("tr").remove();addRow(a,"danger",[b.responseText?b.responseText:"Unknown error"])})}if(login){updateAlerts();setInterval(updateAlerts,30000)}$(".form-alerts").submit(function(b){b.preventDefault();var a=$(this).find(".alert");$.ajax({url:"/setexpr/",method:"POST",data:$.param({expr:"if("+$("#func").val()+"(stat)"+$("#cond").val()+$("#value").val()+',"'+$("#mssg").val()+'",null)',parts:[$("#func").val(),$("#cond").val(),$("#value").val(),$("#mssg").val()].join(":")})}).done(function(){a.removeClass("alert-danger").addClass("alert-success").hide();a.text("OK").show();setTimeout(function(){window.location="/"},2000)}).fail(function(c){a.addClass("alert-danger").text(c.responseText?c.responseText:"Unknown error").show()})});function plot(){d3.json("/series/",function(n,h){var d=new Date();var j=new Date(1970,1,1);var g=0;var l=938;var m=250;var p=4;var f=0.5;var i=d3.select("#js-case-plot").append("svg").attr("style","caseplotCanvas").attr("width",l+g).attr("height",m+g*2).append("g").attr("transform","translate("+g+","+g+")");if(!(h&&h.points&&h.points.length)){i.append("text").text("No data for period").attr("x",330).attr("y",120).attr("font-size","32px");return}h=h.points;h.forEach(function(r){r.dt=new Date(r.dt);r.val=+r.val;if(d>r.dt){d=r.dt}if(j<r.dt){j=r.dt}});var o=d3.time.scale().range([0,l]).domain([d,j]);var c=d3.scale.linear().range([m,0]).domain([0,200]);var e=["200","150","100","80","60","0"];i.selectAll("rect").data(e).enter().append("rect").attr("x",0).attr("y",function(s,r){return r*(m/e.length)}).attr("width",l).attr("height",m/e.length).attr("fill",function(t,r){var s=200+r*(65/(e.length-1));return"rgb(255,"+s+","+s+")"});i.selectAll(".leftLabels").data(e).enter().append("text").text(function(r){return r}).attr("x",0).attr("y",function(t,s){var r=m/e.length;return(s+1)*r-9}).attr("text-anchor","end").attr("fill","#333").attr("font-size",10);h.forEach(function(r){if(r.evt){i.append("line").attr("class","evtline").attr("x1",o(r.dt)).attr("y1",0).attr("x2",o(r.dt)).attr("y2",255)}});var q=d3.svg.line().x(function(r){return o(r.dt)}).y(function(r){return c(r.val)});i.append("path").attr("d",q(h));var k=i.selectAll("circle").data(h).enter().append("circle").attr("r",p).attr("cx",function(r){return o(r.dt)}).attr("cy",function(r){return c(r.val)}).attr("fill-opacity",0.5).attr("fill","red");$("svg circle").tipsy({gravity:"w",html:true,offset:20,opacity:0.7,title:function(){var r=this.__data__;return $("<div/>").text(r.dt.toReadString()).html()+"<br/><br/>"+$("<div/>").text(r.val+" bpm").html()+(r.evt?"<br/><br/>"+$("<div/>").text(r.evt).html():"")}});if(!login){i.append("text").text("Example").attr("x",10).attr("y",20).attr("font-size","12px")}var b=function(){var r=d3.select(this);r.focused=true;r.transition().duration(800).attr("fill-opacity",1).attr("r",p*2).ease("elastic")};var a=function(){var r=d3.select(this);r.focused=false;r.transition().duration(800).attr("fill-opacity",f).attr("r",p).ease("elastic")};k.on("mouseover",b);k.on("mouseout",a)})}plot();